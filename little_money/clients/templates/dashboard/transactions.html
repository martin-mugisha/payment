{% extends "dashboard/base_loan_client.html" %}
{% block title %}Transactions{% endblock %}

{% block content %}
<h2>Transaction History</h2>

<!-- Filters Form -->
<form id="filterForm" method="get" style="display: flex; align-items: center; gap: 20px; white-space: nowrap; overflow-x: auto; padding-bottom: 10px; width: 100%; max-width:fit-content; margin: 0 auto;">

  <div style="display: flex; align-items: center; gap: 5px;">
    <label for="start_date" style="min-width: 80px;">Start Date</label>
    <input type="date" name="start_date" id="start_date" value="{{ request.GET.start_date }}" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px;">
  </div>

  <div style="display: flex; align-items: center; gap: 5px;">
    <label for="end_date" style="min-width: 80px;">End Date</label>
    <input type="date" name="end_date" id="end_date" value="{{ request.GET.end_date }}" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px;">
  </div>

  <div style="display: flex; align-items: center; gap: 5px;">
    <label for="transaction_type" style="min-width: 110px;">Transaction Type</label>
    <input type="text" name="transaction_type" id="transaction_type" value="{{ request.GET.transaction_type }}" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="e.g. Cash In">
  </div>

  <div style="display: flex; align-items: center; gap: 5px;">
    <label for="channel" style="min-width: 60px;">Channel</label>
    <input type="text" name="channel" id="channel" value="{{ request.GET.channel }}" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="e.g. MTN">
  </div>

  <div style="display: flex; align-items: center; gap: 5px;">
    <label for="recipient" style="min-width: 70px;">Recipient</label>
    <input type="text" name="recipient" id="recipient" value="{{ request.GET.recipient }}" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Recipient name">
  </div>

  <div style="display: flex; align-items: center; gap: 5px;">
    <label for="phone" style="min-width: 90px;">Phone Number</label>
    <input type="text" name="phone" id="phone" value="{{ request.GET.phone }}" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="e.g. 0701234567">
  </div>

  <button type="submit" class="btn-download-statement" style="padding: 8px 18px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.3s;">
    Filter
  </button>

</form>



<!-- Download Statement Button moved to top right -->
<div style="text-align: right; margin-bottom: 20px;">
  <button class="btn-download-statement" onclick="downloadStatements()">Download Excel</button>
</div>

{% load humanize %}

<table class="data-table">
  <thead>
    <tr>
      <th scope="col">Transaction ID</th>
      <th scope="col">Date</th>
      <th scope="col">Time</th>
      <th scope="col">Recipient</th>
      <th scope="col">Phone Number</th>
      <th scope="col">Amount</th>
      <th scope="col">Transaction Type</th>
      <th scope="col">Channel</th>
      <th scope="col">Status</th>
      <th scope="col">Action</th>
    </tr>
  </thead>
  <tbody>
    {% for txn in transaction_history %}
    <tr>
      <td>{{ txn.transaction_id }}</td>
      <td>{{ txn.date|default:"--" }}</td>
      <td>{{ txn.time|default:"--:--" }}</td>
      <td>{{ txn.recipient|default:"--" }}</td>
      <td>{{ txn.phone|default:"--" }}</td>
      <td>{{ txn.amount|floatformat:2|intcomma|default:"0.00" }}</td>
      <td>{{ txn.transaction_type|default:"--" }}</td>
      <td>{{ txn.payment_method|default:"--" }}</td>
      <td>
        <span class="status-badge status-{{ txn.status|lower|default:"pending" }}">
          {{ txn.status|default:"Pending" }}
        </span>
      </td>
      <td>
        <button class="btn-download-receipt" onclick="downloadReceipt('{{ txn.transaction_id }}')">Download Receipt</button>
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="10" style="text-align: center; padding: 20px;">No transactions found</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<style>

/* Status badges */
.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.status-success {
  background-color: #d4edda;
  color: #155724;
}

.status-pending {
  background-color: #fff3cd;
  color: #856404;
}

.status-failed {
  background-color: #f8d7da;
  color: #721c24;
}

/* Download buttons */
.btn-download-statement {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.3s;
}

.btn-download-statement:hover {
  background-color: #0056b3;
}

.btn-download-receipt {
  background-color: #28a745;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: background-color 0.3s;
}

.btn-download-receipt:hover {
  background-color: #1e7e34;
}
</style>

<script>
function getFilterQueryParams() {
  const form = document.getElementById('filterForm');
  const params = new URLSearchParams(new FormData(form));
  return params.toString();
}

function downloadStatements() {
  const queryParams = getFilterQueryParams();
  window.location.href = "{% url 'client:download_statement' %}?" + queryParams;
}

function downloadReceipt(transactionId) {
  window.location.href = `/client/transactions/receipt/${transactionId}/`;
}
</script>

{% endblock %}
